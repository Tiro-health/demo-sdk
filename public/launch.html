<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Radiology Report</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "-apple-system", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- Theme detection script (runs before render to prevent flash) -->
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const themeParam = params.get("theme");

        let isDark;
        if (themeParam === "dark") {
          isDark = true;
        } else if (themeParam === "light") {
          isDark = false;
        } else {
          // Default to system preference
          isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        }

        if (isDark) {
          document.documentElement.classList.add("dark");
        }
      })();
    </script>

    <!-- Google Fonts (required for Tiro Web SDK) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lexend:wght@100..900&family=Fira+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tiro Web SDK CSS -->
    <link
      rel="stylesheet"
      href="https://storage.googleapis.com/atticus-assets.tiro.health/sdk-dev/latest/style.css"
    />

    <style>
      tiro-form-filler {
        display: block;
        height: 100%;
      }

      /* Magic Clipboard Popover - Light mode */
      [popover] {
        background: rgb(255, 255, 255);
        border: 1px solid rgb(229, 229, 229);
        border-radius: 0.5rem;
        padding: 0;
        width: min(500px, 90vw);
        max-height: 80vh;
        overflow: hidden;
      }

      /* Magic Clipboard Popover - Dark mode */
      .dark [popover] {
        background: rgb(23, 23, 23);
        border: 1px solid rgb(38, 38, 38);
      }

      [popover]::backdrop {
        background: rgba(0, 0, 0, 0.5);
      }

      .popover-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgb(229, 229, 229);
      }

      .dark .popover-header {
        border-bottom-color: rgb(38, 38, 38);
      }

      .popover-header h2 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: rgb(23, 23, 23);
      }

      .dark .popover-header h2 {
        color: rgb(229, 229, 229);
      }

      .popover-close {
        background: none;
        border: none;
        color: rgb(115, 115, 115);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.25rem;
        line-height: 1;
      }

      .popover-close:hover {
        color: rgb(23, 23, 23);
      }

      .dark .popover-close:hover {
        color: rgb(229, 229, 229);
      }

      .popover-content {
        padding: 1rem;
        max-height: calc(80vh - 3rem);
        overflow-y: auto;
      }

      tiro-magic-clipboard {
        display: block;
      }
    </style>
  </head>
  <body
    class="bg-neutral-50 text-neutral-800 dark:bg-neutral-950 dark:text-neutral-200"
  >
    <!-- Loading overlay (hidden by default) -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-white/95 dark:bg-neutral-950/95 items-center justify-center z-50 hidden"
    >
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-4 border-neutral-300 dark:border-neutral-600 border-t-blue-500 mb-4 mx-auto"
        ></div>
        <p class="text-neutral-800 dark:text-neutral-200 text-lg">
          Generating report...
        </p>
        <p class="text-neutral-500 text-sm mt-2">This may take a few seconds</p>
      </div>
    </div>

    <!-- Magic Clipboard Popover -->
    <div id="magic-clipboard-popover" popover>
      <div class="popover-header">
        <h2>Magic Clipboard</h2>
        <button
          class="popover-close"
          popovertarget="magic-clipboard-popover"
          popovertargetaction="hide"
        >
          Ã—
        </button>
      </div>
      <div class="popover-content">
        <tiro-magic-clipboard for="report-form"></tiro-magic-clipboard>
      </div>
    </div>

    <div class="h-full flex flex-col p-4 font-sans">
      <!-- Toolbar -->
      <div class="flex justify-end mb-3 gap-2">
        <button
          popovertarget="magic-clipboard-popover"
          class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72"
            />
            <path d="m14 7 3 3" />
            <path d="M5 6v4" />
            <path d="M19 14v4" />
            <path d="M10 2v2" />
            <path d="M7 8H3" />
            <path d="M21 16h-4" />
            <path d="M11 3H9" />
          </svg>
          Autofill
        </button>
        <button
          type="submit"
          formId="questionnaire-form"
          class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors"
        >
          Submit
        </button>
      </div>

      <div class="flex-1 min-h-0 overflow-auto">
        <tiro-form-filler
          id="report-form"
          sdc-endpoint-address="https://sdc-service-dev-35032072625.europe-west1.run.app/fhir/r5"
        >
          <script type="application/fhir+json" slot="questionnaire">
            {
              "resourceType": "Questionnaire",
              "id": "radiology-report",
              "status": "draft",
              "title": "Radiology Report",
              "url": "http://demo.tiro.health/Questionnaire/radiology-report",
              "version": "1.0.0",
              "extension": [
                {
                  "url": "http://fhir.tiro.health/StructureDefinition/narrative-template",
                  "valueExpression": {
                    "language": "text/liquid",
                    "expression": "<h1>Radiology Report</h1>{% for item in all_items %}<div class=\"section\"><h2>{{ item.text }}</h2>{% for answer in item.answer %}<p>{{ answer.valueString }}</p>{% endfor %}{% for nested in item.item %}{% for answer in nested.answer %}<p>{{ answer.valueString }}</p>{% endfor %}{% endfor %}</div>{% endfor %}"
                  }
                }
              ],
              "item": [
                {
                  "linkId": "findings",
                  "type": "group",
                  "text": "Findings",
                  "extension": [
                    {
                      "url": "http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl",
                      "valueCodeableConcept": {
                        "coding": [
                          {
                            "system": "http://fhir.tiro.health/CodeSystem/tiro-item-control",
                            "code": "block"
                          }
                        ]
                      }
                    }
                  ],
                  "item": [
                    {
                      "linkId": "findings-text",
                      "type": "text",
                      "text": "Findings Text",
                      "extension": [
                        {
                          "url": "http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl",
                          "valueCodeableConcept": {
                            "coding": [
                              {
                                "system": "http://fhir.tiro.health/CodeSystem/tiro-item-control",
                                "code": "notes"
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                },
                {
                  "linkId": "impression",
                  "type": "text",
                  "text": "Impression"
                },
                {
                  "linkId": "recommendations",
                  "type": "text",
                  "text": "Recommendations"
                }
              ]
            }
          </script>
        </tiro-form-filler>
      </div>
    </div>

    <!-- Tiro Web SDK IIFE Bundle -->
    <script src="https://storage.googleapis.com/atticus-assets.tiro.health/sdk-dev/latest/tiro-web-sdk.iife.js"></script>

    <script>
      // ============================================
      // Configuration
      // ============================================
      // Use local SDC server for development
      const EXTRACT_ENDPOINT =
        "http://localhost:8000/fhir/r5/QuestionnaireResponse/$extract";

      // ============================================
      // URL Parameters
      // ============================================
      const params = new URLSearchParams(window.location.search);
      const patientId = params.get("patientId");
      const accessionNumber = params.get("accessionNumber");

      // ============================================
      // DOM Elements
      // ============================================
      const form = document.getElementById("report-form");
      const loadingOverlay = document.getElementById("loading-overlay");

      // ============================================
      // SDC Client Setup
      // ============================================
      const sdcClient = new TiroWebSdk.SDCClient({
        baseUrl:
          "https://sdc-service-staging-35032072625.europe-west1.run.app/fhir/r5",
      });
      form.sdcClient = sdcClient;
      console.log("SDC client configured:", sdcClient.getConfig());

      // ============================================
      // Utility Functions
      // ============================================

      function showLoading() {
        loadingOverlay.classList.remove("hidden");
        loadingOverlay.classList.add("flex");
      }

      function hideLoading() {
        loadingOverlay.classList.add("hidden");
        loadingOverlay.classList.remove("flex");
      }

      function showError(message, error = null) {
        hideLoading();
        if (error) {
          console.error(message, error);
        }
        alert(`Error: ${message}`);
      }

      /**
       * Extract the Questionnaire JSON from the form slot
       */
      function getQuestionnaireFromForm() {
        const scriptTag = document.querySelector(
          'tiro-form-filler script[type="application/fhir+json"]',
        );
        if (!scriptTag) {
          console.error("Questionnaire script tag not found in form");
          return null;
        }
        try {
          return JSON.parse(scriptTag.textContent);
        } catch (e) {
          console.error("Failed to parse Questionnaire JSON:", e);
          return null;
        }
      }

      /**
       * Build QuestionnaireResponse with contained Questionnaire for $extract
       */
      function buildExtractRequest(qr, questionnaire) {
        const containedQuestionnaire = {
          ...questionnaire,
          id: questionnaire.id || "contained-questionnaire",
        };

        return {
          ...qr,
          questionnaire: `#${containedQuestionnaire.id}`,
          contained: [containedQuestionnaire],
        };
      }

      /**
       * Call the $extract endpoint and return the PDF data
       */
      async function callExtractEndpoint(extractRequest) {
        const url = new URL(EXTRACT_ENDPOINT);
        // Note: Skipping subject parameter as backend expects numeric IDs
        // In production, this would use actual patient database IDs

        const response = await fetch(url.toString(), {
          method: "POST",
          headers: {
            "Content-Type": "application/fhir+json",
            Accept: "application/fhir+json",
          },
          body: JSON.stringify(extractRequest),
        });

        if (!response.ok) {
          let errorMessage = `HTTP ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.issue && errorData.issue.length > 0) {
              errorMessage = errorData.issue
                .map((i) => i.diagnostics || i.details?.text)
                .join("; ");
            }
          } catch (e) {
            // Ignore JSON parsing error for error response
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        if (data.resourceType !== "Parameters") {
          throw new Error("Invalid response: expected Parameters resource");
        }

        const returnParam = data.parameter?.find((p) => p.name === "return");
        if (!returnParam || !returnParam.resource) {
          throw new Error("No DocumentReference in response");
        }

        const docRef = returnParam.resource;
        if (docRef.resourceType !== "DocumentReference") {
          throw new Error("Expected DocumentReference resource");
        }

        const attachment = docRef.content?.[0]?.attachment;
        if (!attachment || !attachment.data) {
          throw new Error("No PDF attachment in DocumentReference");
        }

        if (attachment.contentType !== "application/pdf") {
          throw new Error(`Unexpected content type: ${attachment.contentType}`);
        }

        return {
          pdfData: attachment.data,
          title: attachment.title || "Report",
        };
      }

      // ============================================
      // Event Listeners
      // ============================================

      form.addEventListener("tiro-ready", (event) => {
        console.log("Questionnaire loaded:", event.detail.questionnaire);
      });

      form.addEventListener("tiro-update", (event) => {
        console.log("Form updated:", event.detail.response);
      });

      form.addEventListener("tiro-submit", async (event) => {
        console.log("Form submitted:", event.detail.response);

        const qr = event.detail.response;

        try {
          showLoading();

          // Get the Questionnaire from the form
          const questionnaire = getQuestionnaireFromForm();
          if (!questionnaire) {
            throw new Error("Could not retrieve Questionnaire from form");
          }

          // Build the request with contained Questionnaire
          const extractRequest = buildExtractRequest(qr, questionnaire);
          console.log("Calling $extract with:", extractRequest);

          // Call the $extract endpoint
          const { pdfData, title } = await callExtractEndpoint(extractRequest);
          console.log(
            "PDF extracted successfully, size:",
            pdfData.length,
            "chars",
          );

          // Generate unique key for localStorage
          const id = crypto.randomUUID();
          const key = `Report/${id}`;

          // Store PDF data with context
          const storageData = {
            pdfData: pdfData,
            title: title,
            context: {
              patientId: patientId,
              accessionNumber: accessionNumber,
              submittedAt: new Date().toISOString(),
            },
          };
          localStorage.setItem(key, JSON.stringify(storageData));
          console.log("PDF stored in localStorage:", key);

          // Navigate to callback page
          window.location.href = `/callback.html?report=${encodeURIComponent(key)}`;
        } catch (error) {
          showError(error.message || "Failed to generate report", error);
        }
      });

      form.addEventListener("tiro-error", (event) => {
        console.error(
          "Form error:",
          event.detail.error,
          "Type:",
          event.detail.type,
        );
      });

      // ============================================
      // Magic Clipboard Event Listeners
      // ============================================
      const clipboard = document.querySelector("tiro-magic-clipboard");
      const popover = document.getElementById("magic-clipboard-popover");

      clipboard.addEventListener("tiro-populate-start", () => {
        console.log("Magic clipboard: starting population...");
      });

      clipboard.addEventListener("tiro-populate-complete", (event) => {
        console.log(
          "Magic clipboard: population complete",
          event.detail.response,
        );
        popover.hidePopover();
      });

      clipboard.addEventListener("tiro-populate-error", (event) => {
        console.error("Magic clipboard error:", event.detail.error);
      });
    </script>
  </body>
</html>
